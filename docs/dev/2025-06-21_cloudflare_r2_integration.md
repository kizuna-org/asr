# Cloudflare R2 Integration

Date: 2025-06-21

## Overview

This document describes the integration of Cloudflare R2 storage into our infrastructure using Terraform. R2 is used for storing logs, status information, and other artifacts generated by our application.

## Changes Made

1. Added Cloudflare provider to Terraform configuration
2. Created R2 bucket resource in Terraform
3. Updated locals.tf with Cloudflare configuration variables
4. Added outputs for R2 bucket information
5. Created root .env file with R2 configuration

## Configuration Requirements

To use the Cloudflare R2 integration, you need to:

1. Create a Cloudflare account if you don't have one
2. Create an API token with R2 permissions
3. Update the following values in `infrastructure/terraform/locals.tf`:
   - `cloudflare_account_id`: Your Cloudflare account ID
   - `cloudflare_api_token`: Your Cloudflare API token
   - `r2_access_key_id`: Your R2 access key ID
   - `r2_secret_access_key`: Your R2 secret access key
   - `r2_bucket_name`: Your desired bucket name (default: "chumchat-storage")

## Usage

After applying the Terraform configuration, the R2 bucket will be created and the necessary environment variables will be available in the .env file.

The application uses the R2 client to:
1. Stream logs to R2
2. Store and retrieve job status information
3. Store artifacts generated by the application

## Implementation Details

The R2 client is initialized in both the main application and the subscriber using the boto3 library with the following configuration:

```python
r2_client = boto3.client(
    's3',
    endpoint_url=os.environ.get('R2_ENDPOINT_URL'),
    aws_access_key_id=os.environ.get('R2_ACCESS_KEY_ID'),
    aws_secret_access_key=os.environ.get('R2_SECRET_ACCESS_KEY'),
    config=Config(signature_version='s3v4'),
    region_name='auto'
)
```

This allows the application to interact with the R2 bucket using the S3 API.